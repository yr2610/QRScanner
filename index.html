<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Log Scanner</title>
  <link rel="manifest" href="./manifest.webmanifest?v=3" />
  <meta name="theme-color" content="#111827" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif; margin:0; background:#0b1020; color:#e5e7eb; }
    header { padding:12px 16px; border-bottom:1px solid #1f2937; display:flex; align-items:center; gap:12px; }
    h1 { font-size:18px; margin:0; }
    main { padding:16px; display:grid; gap:16px; max-width:960px; margin:0 auto; }
    .card { background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:16px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    button, select { background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button[disabled]{opacity:.5; cursor:not-allowed;}
    button:hover { background:#1f2937; }
    .muted { color:#9ca3af; font-size:12px; }
    #reader { width:75%; max-width:480px; margin:0; aspect-ratio:4/3; }
    #missing { display:block; max-width:100%; white-space:normal; overflow:hidden; line-height:1.4; max-height:2.8em; }
    textarea { width:100%; height:200px; resize:vertical; background:#0b1020; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:8px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#111827; border:1px solid #374151; font-size:12px; }
    .skipcode-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .skipcode-row code { font-size:18px; letter-spacing:2px; }
  </style>
</head>
<body>
  <header>
    <h1>QR Log Scanner</h1>
    <span class="pill" id="pwaStatus">PWA</span>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="btnStart" disabled>読み取り開始</button>
        <button id="btnStop" disabled>停止</button>
        <button id="btnReset">セッション初期化</button>
        <span class="muted">※ HTTPS/localhost でのみカメラ使用可</span>
      </div>
      <div id="reader" class="card"></div>
      <div class="row">
        <label>カメラ: <select id="cameraSelect"></select></label>
        <label><input type="checkbox" id="chkTorch"/> トーチ（対応端末）</label>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div>
          <h3 style="margin:0 0 8px">進捗</h3>
          <div class="row" style="gap:16px">
            <div>セッション: <code id="sessionId">(未検出)</code></div>
            <div>受信: <span id="progress">0/0</span></div>
            <div>進捗: <span id="progressPercent">0%</span></div>
            <div>不足: <span id="missing">-</span></div>
          </div>
          <div class="skipcode-row">
            <div>SkipCode32: <code id="skipCode">0000000</code></div>
          </div>
          <p class="muted" style="margin:4px 0 0">7桁入力＝そのまま、6桁以下＝H5T2（途中入力でもOK）。ヘッダのみの場合は不足帯域を31（w/-）で補完します。画面表示の「-」は w と同じ意味です。</p>
          <p class="muted" style="margin-top:8px">QRテキスト形式: <code>Q4|&lt;idxHex&gt;/&lt;totHex&gt;|&lt;sid&gt;|&lt;payload&gt;</code></p>
        </div>
        <div>
          <h3 style="margin:0 0 8px">受信ログ（結合プレビュー）</h3>
          <textarea id="preview" placeholder="受信済みのチャンクを連結して表示"></textarea>
          <div class="row" style="justify-content:flex-end">
            <button id="btnSaveTxt">.txt として保存</button>
            <button id="btnShareTxt">共有（Gmail/Drive など）</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- html5-qrcode（ローカル同梱推奨） -->
  <script src="./libs/html5-qrcode.min.js?v=3"></script>
  <script type="module">
    import { encode, makeMaskFromGot, pretty } from './skipcode32.js?v=2';

    // PWA登録（失敗しても無視）
    (async () => {
      if (window.matchMedia('(display-mode: standalone)').matches)
        document.getElementById('pwaStatus').textContent = 'PWA ✓';
      if ('serviceWorker' in navigator) { try { await navigator.serviceWorker.register('./sw.js?v=3'); } catch {} }
    })();

    // 状態
    let currentSession = null, total = 0;
    const chunks = new Map();
    const els = {
      session: document.getElementById('sessionId'),
      progress: document.getElementById('progress'),
      progressPercent: document.getElementById('progressPercent'),
      missing: document.getElementById('missing'),
      preview: document.getElementById('preview'),
      cameraSelect: document.getElementById('cameraSelect'),
      chkTorch: document.getElementById('chkTorch'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      skipCode: document.getElementById('skipCode'),
    };

    const INITIAL_MASK = 0 >>> 0;
    let prevCompleteMask = INITIAL_MASK;
    let lastDisplayCode = encode((~INITIAL_MASK) >>> 0);

    function resetSession() {
      currentSession = null; total = 0; chunks.clear();
      els.session.textContent = '(未検出)';
      els.progress.textContent = '0/0';
      els.progressPercent.textContent = '0%';
      els.missing.textContent = '-';
      els.preview.value = '';
      prevCompleteMask = INITIAL_MASK;
      lastDisplayCode = encode((~prevCompleteMask) >>> 0);
      els.skipCode.textContent = pretty(lastDisplayCode);
    }
    function vibrateOnSkipCodeChange() {
      if (navigator.vibrate) navigator.vibrate(20);
    }
    function updateProgress() {
      const have = chunks.size;
      els.progress.textContent = `${have}/${total}`;
      if (!total) {
        els.progressPercent.textContent = '0%';
        els.missing.textContent = '-';
        prevCompleteMask = INITIAL_MASK;
        const displayCode = encode((~prevCompleteMask) >>> 0);
        if (displayCode !== lastDisplayCode) {
          lastDisplayCode = displayCode;
          vibrateOnSkipCodeChange();
        }
        els.skipCode.textContent = pretty(displayCode);
        return;
      }

      const percent = ((have / total) * 100).toFixed(0);
      els.progressPercent.textContent = `${percent}%`;

      const maxDisplay = 20;
      const missShown = [];
      let remainder = 0;
      const got = new Array(total);
      for (let i = 1; i <= total; i++) {
        const hasChunk = chunks.has(i);
        got[i - 1] = hasChunk;
        if (!hasChunk) {
          if (missShown.length < maxDisplay) {
            missShown.push(i);
          } else {
            remainder++;
          }
        }
      }

      if (!missShown.length && remainder === 0) {
        els.missing.textContent = 'なし';
      } else {
        const shown = missShown.join(',');
        els.missing.textContent = remainder > 0 ? `${shown} …(+${remainder})` : shown;
      }

      const completeMask = makeMaskFromGot(got, total);
      const monotonicComplete = (prevCompleteMask | completeMask) >>> 0;
      prevCompleteMask = monotonicComplete;
      const displayCode = encode((~monotonicComplete) >>> 0);
      if (displayCode !== lastDisplayCode) {
        lastDisplayCode = displayCode;
        vibrateOnSkipCodeChange();
      }
      els.skipCode.textContent = pretty(displayCode);

      if (have === total) {
        let out = '';
        for (let i = 1; i <= total; i++) out += chunks.get(i) || '';
        els.preview.value = out;
      }
    }

    // 新旧フォーマット対応のパーサ
    function ingestPayload(text) {
      // 新: Q4|<idxHex>/<totHex>|<sid>|<payload>
      let m = text.match(/^Q4\|([0-9A-F]{1,4})\/([0-9A-F]{1,4})\|([0-9A-Z]{3,4})\|(.*)$/i);
      let idx, tot, ses, payload;
      if (m) {
        idx = parseInt(m[1], 16);
        tot = parseInt(m[2], 16);
        ses = m[3].toUpperCase();
        payload = m[4];
      } else {
        // 旧: [idx/total]|session|payload（10進）
        m = text.match(/^\[(\d+)\/(\d+)\]\|(.*?)\|(.*)$/s);
        if (!m) return;
        idx = Number(m[1]);
        tot = Number(m[2]);
        ses = m[3];
        payload = m[4];
      }
      if (!(Number.isInteger(idx) && Number.isInteger(tot) && idx>=1 && tot>=1 && idx<=tot)) return;
      if (!currentSession) { currentSession = ses; total = tot; els.session.textContent = currentSession; }
      if (ses !== currentSession || tot !== total) return;
      if (!chunks.has(idx)) { chunks.set(idx, payload); updateProgress(); }
    }

    // カメラ
    const html5Qr = new window.Html5Qrcode('reader');
    let running = false;
    async function listCameras() {
      try {
        const devices = await window.Html5Qrcode.getCameras();
        els.cameraSelect.innerHTML = '';
        if (!devices || !devices.length) {
          const o = document.createElement('option'); o.text = '（カメラ検出なし）'; els.cameraSelect.add(o); return;
        }
        devices.forEach(d => { const o=document.createElement('option'); o.value=d.id; o.text=d.label||d.id; els.cameraSelect.add(o); });
        els.btnStart.disabled = false;
      } catch {
        const o = document.createElement('option'); o.text = '（列挙失敗）'; els.cameraSelect.add(o);
      }
    }

    async function start() {
      if (running) return;
      const camId = els.cameraSelect.value || undefined;
      await html5Qr.start(
        camId ? { deviceId: { exact: camId } } : { facingMode: 'environment' },
        { fps: 15, qrbox: { width: 480, height: 360 } },
        (t)=> ingestPayload(t.trim()),
        ()=>{}
      );
      running = true; els.btnStart.disabled = true; els.btnStop.disabled = false;
    }
    async function stop() {
      if (!running) return;
      await html5Qr.stop();
      running = false; els.btnStart.disabled = false; els.btnStop.disabled = true;
    }

    els.chkTorch.addEventListener('change', async (ev) => {
      try { await html5Qr.applyVideoConstraints({ advanced: [{ torch: ev.target.checked }] }); } catch {}
    });

    function getResultBlob() { return new Blob([els.preview.value || ''], { type: 'text/plain' }); }
    document.getElementById('btnSaveTxt').addEventListener('click', () => {
      const blob = getResultBlob(); const a=document.createElement('a'); const url=URL.createObjectURL(blob);
      a.href=url; a.download=`qrlog-${currentSession||'session'}-${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
      a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    });
    document.getElementById('btnShareTxt').addEventListener('click', async () => {
      const file = new File([getResultBlob()], `qrlog-${currentSession||'session'}.txt`, { type:'text/plain' });
      if (navigator.canShare && navigator.canShare({ files:[file] })) {
        try { await navigator.share({ files:[file], title:'QR Log', text:'連結ログ' }); } catch {}
      } else {
        const a=document.createElement('a'); const url=URL.createObjectURL(file);
        a.href=url; a.download=file.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
      }
    });

    (async () => { resetSession(); await listCameras(); updateProgress(); })();
    document.getElementById('btnStart').addEventListener('click', start);
    document.getElementById('btnStop').addEventListener('click', stop);
    document.getElementById('btnReset').addEventListener('click', resetSession);
  </script>
</body>
</html>
